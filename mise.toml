# ~/.agents エージェント・スキル管理用 mise 設定

[env]
_.path = ['./node_modules/.bin']
MARKDOWN_LINK_CONFIG = ".markdown-link-check.json"

[tools]
node = '24'                          # Node 24 系に固定
fd = 'latest'                        # ファイル検索用
"npm:prettier" = 'latest'            # コードフォーマッター
"npm:markdownlint-cli2" = "latest"   # Markdown lint
"npm:markdown-link-check" = "latest" # Markdown リンクチェック

# === ドキュメント管理 ===
[tasks."docs:lint"]
description = "Markdownファイルのlintチェック"
run = "fd -e md --type f --no-follow -X markdownlint-cli2"

[tasks."docs:fix"]
description = "Markdownファイルの自動修正"
run = "fd -e md --type f --no-follow -X markdownlint-cli2 --fix"

[tasks."docs:links"]
description = "Markdownリンクチェック"
run = "fd -e md --type f --no-follow -X markdown-link-check --quiet --config ${MARKDOWN_LINK_CONFIG}"

[tasks."docs:links:verbose"]
description = "Markdownリンクチェック（詳細モード）"
run = "fd -e md --type f --no-follow -X markdown-link-check --verbose --config ${MARKDOWN_LINK_CONFIG}"

[tasks."docs:format"]
description = "Prettierでフォーマット"
run = "fd -e md --type f --no-follow -X prettier --write --log-level warn"

[tasks."docs:format:check"]
description = "Prettierフォーマットチェック"
run = "fd -e md --type f --no-follow -X prettier --check"

# === エイリアス ===
[tasks.format]
description = "全ての自動修正を実行"
depends = ["skills:fix:bold-headings", "docs:fix", "docs:format"]

[tasks.lint]
description = "全体検証（修正はしない）"
depends = ["docs:lint", "docs:format:check", "docs:links"]

# === スキル管理 (Nix / Home Manager) ===
[tasks."skills:install"]
description = "HM でスキルをインストール"
run = "sh -c 'if [ -n \"${GITHUB_TOKEN:-}\" ]; then export NIX_CONFIG=\"access-tokens = github.com=$GITHUB_TOKEN\"; fi; home-manager switch --flake ~/.agents --impure'"

[tasks."skills:list"]
description = "有効スキル一覧を JSON 出力"
run = "nix run ~/.agents#list"

[tasks."skills:validate"]
description = "スキル構成バリデーション"
run = "nix run ~/.agents#validate"

[tasks."skills:update"]
description = "全ソース更新 + 再インストール"
run = "sh -c 'if [ -n \"${GITHUB_TOKEN:-}\" ]; then export NIX_CONFIG=\"access-tokens = github.com=$GITHUB_TOKEN\"; fi; nix flake update --flake ~/.agents || exit $?; home-manager switch --flake ~/.agents --impure'"

[tasks.ci]
description = "lint + スキル更新 + バリデーション"
depends = ["lint", "skills:update", "skills:validate"]

[tasks."skills:fix:bold-headings"]
description = "skills-internal の太字見出しを###へ変換"
run = "node ./scripts/replace-bold-headings.js"
