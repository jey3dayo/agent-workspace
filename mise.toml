# ~/.agents エージェント・スキル管理用 mise 設定

[env]
_.path = ['./node_modules/.bin']
MARKDOWN_LINK_CONFIG = ".markdown-link-check.json"

[tools]
node = '24'                          # Node 24 系に固定
fd = 'latest'                        # ファイル検索用
"npm:prettier" = 'latest'            # コードフォーマッター
"npm:markdownlint-cli2" = "latest"   # Markdown lint
"npm:markdown-link-check" = "latest" # Markdown リンクチェック

# === ドキュメント管理 ===
[tasks."docs:lint"]
description = "Markdownファイルのlintチェック"
run = "fd -e md --type f --no-follow -X markdownlint-cli2"

[tasks."docs:fix"]
description = "Markdownファイルの自動修正"
run = "fd -e md --type f --no-follow -X markdownlint-cli2 --fix"

[tasks."docs:links"]
description = "Markdownリンクチェック"
run = "fd -e md --type f --no-follow -X markdown-link-check --quiet --config ${MARKDOWN_LINK_CONFIG}"

[tasks."docs:links:verbose"]
description = "Markdownリンクチェック（詳細モード）"
run = "fd -e md --type f --no-follow -X markdown-link-check --verbose --config ${MARKDOWN_LINK_CONFIG}"

[tasks."docs:format"]
description = "Prettierでフォーマット"
run = "fd -e md --type f --no-follow -X prettier --write --log-level warn"

[tasks."docs:format:check"]
description = "Prettierフォーマットチェック"
run = "fd -e md --type f --no-follow -X prettier --check"

# === エイリアス ===
[tasks.format]
description = "全ての自動修正を実行"
depends = ["skills:fix:bold-headings", "docs:fix", "docs:format"]

[tasks.lint]
description = "全体検証（修正はしない）"
depends = ["docs:lint", "docs:format:check", "docs:links"]

# === スキル管理 (Nix / Home Manager) ===
[tasks."skills:install"]
description = "HM でスキルをインストール"
run = "home-manager switch --flake ~/.agents --impure"

[tasks."skills:list"]
description = "有効スキル一覧を JSON 出力"
run = "nix run ~/.agents#list"

[tasks."skills:validate"]
description = "スキル構成バリデーション"
run = "nix run ~/.agents#validate"

[tasks."skills:update"]
description = "全ソース更新（flake inputs）"
run = "nix flake update --flake ~/.agents"

[tasks.ci]
description = "lint + バリデーション + スキルインストール"
depends = ["lint", "skills:validate", "skills:install"]

[tasks."ci:full"]
description = "skills:update + ci"
depends = ["skills:update", "ci"]

[tasks.update]
description = "全ソース更新 + 再インストール"
depends = ["skills:update", "skills:install"]

# === セットアップ ===
[tasks."setup:token"]
description = "gh auth token で Nix アクセストークンを設定"
run = """
#!/usr/bin/env bash
set -euo pipefail

CONF=~/.agents/secrets/nix/access-tokens.conf
NIX_CONF=~/.config/nix/nix.conf
INCLUDE_LINE="!include $HOME/.agents/secrets/nix/access-tokens.conf"

# gh 認証チェック
if ! gh auth status &>/dev/null; then
  echo "ERROR: gh auth login を先に実行してください"
  exit 1
fi

# トークン書き込み
mkdir -p ~/.agents/secrets/nix
chmod 700 ~/.agents/secrets ~/.agents/secrets/nix
echo "access-tokens = github.com=$(gh auth token)" > "$CONF"
chmod 600 "$CONF"
echo "OK: $CONF"

# nix.conf に !include 追加（未設定の場合のみ）
mkdir -p ~/.config/nix
if ! grep -qF 'access-tokens.conf' "$NIX_CONF" 2>/dev/null; then
  echo "$INCLUDE_LINE" >> "$NIX_CONF"
  echo "OK: $NIX_CONF に !include を追加"
else
  echo "SKIP: $NIX_CONF に !include は設定済み"
fi

# 検証
echo "---"
nix config show 2>/dev/null | grep access-tokens && echo "OK: Nix がトークンを認識" || echo "WARN: トークンが認識されていません"
"""

[tasks.setup]
description = "初回セットアップ（トークン + スキルインストール）"
depends = ["setup:token", "skills:install"]

[tasks."skills:fix:bold-headings"]
description = "skills-internal の太字見出しを###へ変換"
run = "node ./scripts/replace-bold-headings.js"
