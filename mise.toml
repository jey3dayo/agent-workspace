# ~/.agents エージェント・スキル管理用 mise 設定

[env]
_.path = ['./node_modules/.bin']
MARKDOWN_LINK_CONFIG = ".markdown-link-check.json"
MD_FILES = "fd -e md --type f --no-follow"

[tools]
node = '24'
fd = 'latest'
"npm:prettier" = 'latest'
"npm:markdownlint-cli2" = "latest"
"npm:markdown-link-check" = "latest"

# === セットアップ ===
[tasks."setup:token"]
description = "gh auth token で Nix アクセストークンを設定"
run = "bash ./scripts/setup-nix-token.sh"

[tasks.setup]
description = "初回セットアップ（トークン + スキルインストール）"
depends = ["setup:token", "skills:install"]

# === ドキュメント管理 ===
[tasks."docs:lint"]
description = "Markdown lint チェック"
run = "$MD_FILES -X markdownlint-cli2"

[tasks."docs:fix"]
description = "Markdown lint 自動修正"
run = "$MD_FILES -X markdownlint-cli2 --fix"

[tasks."docs:links"]
description = "Markdown リンクチェック"
run = "$MD_FILES -X markdown-link-check --quiet --config ${MARKDOWN_LINK_CONFIG}"

[tasks."docs:links:verbose"]
description = "Markdown リンクチェック（詳細）"
run = "$MD_FILES -X markdown-link-check --verbose --config ${MARKDOWN_LINK_CONFIG}"

[tasks."docs:format"]
description = "Prettier フォーマット"
run = "$MD_FILES -X prettier --write --log-level warn"

[tasks."docs:format:check"]
description = "Prettier フォーマットチェック"
run = "$MD_FILES -X prettier --check"

# === スキル管理 ===
[tasks."skills:install"]
description = "HM でスキルをインストール"
run = "nix run home-manager -- switch --flake ~/.agents --impure"

[tasks."skills:list"]
description = "有効スキル一覧を表示"
run = "nix run ~/.agents#list"

[tasks."skills:validate"]
description = "スキル構成バリデーション"
run = "nix run ~/.agents#validate"

[tasks."skills:update"]
description = "全ソース更新（flake inputs）"
run = "nix flake update --flake ~/.agents"

[tasks."skills:fix:bold-headings"]
description = "skills-internal の太字見出しを ### へ変換"
run = "node ./scripts/replace-bold-headings.js"

# === 集約タスク ===
[tasks.format]
description = "全自動修正"
depends = ["skills:fix:bold-headings", "docs:fix", "docs:format"]

[tasks.lint]
description = "全体検証"
depends = ["docs:lint", "docs:format:check", "docs:links"]

[tasks.update]
description = "全ソース更新 + 再インストール"
depends = ["skills:update", "skills:install"]

[tasks.ci]
description = "lint + バリデーション + インストール"
depends = ["lint", "skills:validate", "skills:install"]

[tasks."ci:full"]
description = "全更新 + ci"
depends = ["skills:update", "ci"]
